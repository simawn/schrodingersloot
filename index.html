<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="nekoatsume x lootboxes. Created at McHacks6. Lootbox Simulator. Collect cats. Collect poison. Collect money. Collect them all. Totally not gambling.">
    <meta name="keywords" content="neko atsume, cat, lootboxes, collection, simulator">
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
        crossorigin="anonymous">
    <title>ðŸ˜¸ schroloot - Schrodinger's Loot ðŸ“¦</title>
</head>

<body>

    <!--MAIN PAGE-->

    <div id="container">
        <div id="header">
            <h1>ðŸ˜¸ schroloot ðŸ“¦</h1>

        </div>
        <div id="inventory"><button class="btn btn-primary" data-toggle="modal" data-target="#collection" id="btnCollection">Collection</button></div>
        <div id="cash">
            <h4 id="cAmt" class="alert alert-primary"></h4>
            <p>Click the box to open. (17$)</p>
        </div>
        <div id="animBox"></div>
        <div id="footer">
            <p>Totally not gambling.</p>
            <a href="https://github.com/simawn/schrodingersloot" target="_blank"><i class="fab fa-github fa-2x"></i></a>
        </div>
    </div>

    <!--COLLECTION-->

    <div class="modal fade" id="collection" tabindex="-1" role="dialog" aria-labelledby="collectionLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collectionLabel">Collection</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="colCashDisp"></p>
                    <div id="colItems"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick=restart() class="btn btn-outline-danger" data-dismiss="modal">Restart</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!--OUT OF CASH POPUP-->

    <div class="modal fade" id="oocpop" tabindex="-1" role="dialog" aria-labelledby="oocpoplabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="oocpoplabel">Out of cash! ðŸ˜¿</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Oh no! You can't afford to open this box! Go sell some items in your collection or restart the game.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!--JAVASCRIPT-->

    <script src="js/lottie.js"></script>
    <script>
        //IT'S A COMPLETE MESS DOWN HERE BUT IT WORKS!!!
        //THIS WAS INITIALLY CODED UNDER 24 HOURS AT MCHACKS6
        //WILL SPLIT THEM INTO SPERATE FILES EVENTUALLY.

        const BOXOPENINGCOST = 17;
        const STARTCASH = 50;

        function getCookie(name) {
            var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }

        function setCookie(name, value, days) {
            var d = new Date;
            d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * days);
            document.cookie = name + "=" + value + ";path=/;expires=" + d.toGMTString();
        }

        if (getCookie("cash") == null) {
            setCookie("cash", STARTCASH, 30);
        }

        function updateCashDisplayAmt() {
            document.getElementById("cAmt").innerHTML = "ðŸ’¸ " + getCookie("cash") + "$ ðŸ’µ";
        }

        function updateCashDisplayAmtCollection() {
            document.getElementById("colCashDisp").innerHTML = "ðŸ’¸ " + getCookie("cash") + "$ ðŸ’µ";
        }

        function getCurrentCash() {
            return parseInt(getCookie("cash"));
        }

        function setCurrentCash(amount) {
            setCookie("cash", amount, 30);
        }

        function getItemAmount(itemName) {
            var itemCount = localStorage.getItem(itemName);
            if (itemCount != null) return parseInt(itemCount);
        }

        var boxElement = document.getElementById("animBox"); //Injecting animation in here

        //BOX
        var boxAnimParams = { //Animation params
            container: boxElement,
            renderer: "html",
            loop: true,
            autoplay: false,
            path: "assets/gfx/box/boxMerge.json"
        };
        var box; //Actual animation. Setup in start function

        //CAT
        var catAnimParams = {
            container: boxElement,
            renderer: "svg",
            loop: true,
            autoplay: true,
            path: "assets/gfx/cat/catA.json"
        };
        var cat;

        //POISON
        var poisonAnimParams = {
            container: boxElement,
            renderer: "svg",
            loop: true,
            autoplay: true,
            path: "assets/gfx/obj/poison.json"
        };
        var poison;

        //START
        document.addEventListener("DOMContentLoaded", () => { //When content of the page is loaded
            startBoxAnimation();
        });

        function getPrize() { //RNG
            return parseInt(Math.random() * 1000);
        }

        //not used yet
        const itemDb = {
            0: {
                itemName: "A black cat",
                itemPath: "assets/gfx/cat/catBlack.json",
                itemWorth: 37,
                itemThumb: "assets/img/small/catBlack.png",
            },
            1: {
                itemName: "A black & white cat",
                itemPath: "assets/gfx/cat/catBlackWhite.json",
                itemWorth: 59,
                itemThumb: "assets/img/small/catWhiteBlack.png",
            },
            2: {
                itemName: "An orange cat",
                itemPath: "assets/gfx/cat/catA.json",
                itemWorth: 23,
                itemThumb: "assets/img/small/catA.png",
            },
            3: {
                itemName: "A poison flask",
                itemPath: "assets/gfx/obj/poison.json",
                itemWorth: 3,
                itemThumb: "assets/img/small/poison.png",
            },
            4: {
                itemName: "A blue cat",
                itemPath: "assets/gfx/obj/catBlue.json",
                itemWorth: 67,
                itemThumb: "assets/img/small/catBlue.png",
            },
            5: {
                itemName: "Octocat",
                itemPath: "assets/gfx/obj/octoCat.json",
                itemWorth: 97,
                itemThumb: "assets/img/small/octoCat.png",
            },
        };
        const unknownItem = "assets/img/small/unknownCat.png";

        function showPrize(randNum) { //Process random number
            //Generate item
            var a = parseInt(randNum / 100);
            var b = parseInt(randNum / 10) % 10;
            var c = randNum % 10; //Not used yet
            //console.log(`RNG: ${randNum}, A: ${a}, B: ${b}, C: ${c}`);
            var itemName;
            var itemParams;
            var item; //Animation load
            var worth; //Sell amount
            var itemId;
            //Generate spot for item animation
            var itemDiv = document.createElement("div");
            itemDiv.setAttribute("id", "item");

            if (a <= 5) { //Cat
                itemParams = catAnimParams; //Load anim details

                switch (b) {
                    case 1:
                    case 2:
                    case 3:
                        itemId = 0;
                        itemName = itemDb[itemId]["itemName"];
                        itemParams.path = itemDb[itemId]["itemPath"];
                        worth = itemDb[itemId]["itemWorth"];
                        break;
                    case 4:
                    case 5:
                        itemId = 1;
                        itemName = itemDb[itemId]["itemName"];
                        itemParams.path = itemDb[itemId]["itemPath"];
                        worth = itemDb[itemId]["itemWorth"];
                        break;
                    case 6:
                    case 7:
                    case 8:
                    case 9:
                    case 0:
                        itemId = 2;
                        itemName = itemDb[itemId]["itemName"];
                        itemParams.path = itemDb[itemId]["itemPath"];
                        worth = itemDb[itemId]["itemWorth"];
                        break;
                }
            } else { //Poison
                itemParams = poisonAnimParams; //load anim details

                itemId = 3;
                itemName = itemDb[itemId]["itemName"];
                itemParams.path = itemDb[itemId]["itemPath"];
                worth = itemDb[itemId]["itemWorth"];
            }

            //Item animation display
            itemParams.container = itemDiv; //Mod injection params
            item = bodymovin.loadAnimation(itemParams); //Load cat model

            //Description field on item
            var desc = document.createElement("div");
            desc.setAttribute("id", "desc");
            var h1 = document.createElement("h2");
            var h1Text = document.createTextNode("You looted: " + itemName);
            h1.appendChild(h1Text);
            desc.appendChild(h1);

            //Generate spot for buttons
            var optionDiv = document.createElement("div");
            optionDiv.setAttribute("id", "options");

            //Keep
            var button1 = document.createElement("button");
            button1.setAttribute("id", "keep");
            button1.setAttribute("class", "btn btn-success");
            var button1Text = document.createTextNode("Keep");
            button1.appendChild(button1Text);
            optionDiv.appendChild(button1);

            //Sell
            var button2 = document.createElement("button");
            button2.setAttribute("id", "sell");
            button2.setAttribute("class", "btn btn-danger");
            var button2Text = document.createTextNode("Sell for " + worth + "$");
            button2.appendChild(button2Text);
            optionDiv.appendChild(button2);

            //Inject elements
            boxElement.appendChild(desc);
            boxElement.appendChild(itemDiv);
            boxElement.appendChild(optionDiv);

            //When clicking on a button, reset everything
            function resetStage() {
                item.destroy();
                boxElement.removeChild(desc);
                boxElement.removeChild(itemDiv);
                boxElement.removeChild(optionDiv);
                clicked = false;
                startBoxAnimation();
            }

            //Button actions
            button1.addEventListener("click", () => { //Keep
                var itemAmount = getItemAmount(itemId);
                //console.log(itemAmount);
                if (itemAmount === undefined) {
                    localStorage.setItem(itemId, 1);
                } else {
                    localStorage.setItem(itemId, itemAmount + 1);
                }
                resetStage();
            });

            button2.addEventListener("click", () => { //Sell
                var newWalletValue = getCurrentCash() + worth;
                setCurrentCash(newWalletValue);
                resetStage();
            });
        }

        var clicked = false; //Checking for multiple clicks

        function openBox() {
            if (clicked) return;
            idleMode = false;
            clicked = true; //Avoid multiple clicks
            box.playSegments([210, 290], true); //210-354 FOR FULL LENGTH
            setCurrentCash(getCurrentCash() - BOXOPENINGCOST);
            updateCashDisplayAmt();
            getPrize();
            box.addEventListener("loopComplete", () => {
                box.destroy();
                showPrize(getPrize());
            });
        }



        /*
        When pressing on "Keep" or "Sell", it will register as a 
        click and go immediately to opening box. We don't want that to happen.
        So we create an idleMode flag to prevent that
        */
        var idleMode = true;

        function startBoxAnimation() {

            box = bodymovin.loadAnimation(boxAnimParams);
            box.addEventListener("DOMLoaded", () => { //When animation data is loaded

                var curCash = getCurrentCash();
                updateCashDisplayAmt();

                idleMode = true;

                box.playSegments([31, 156], true); //Jump up and down (idle pose)

                boxElement.addEventListener("click", clickOpen);
            });
        }

        function clickOpen() {
            var curCash = getCurrentCash();
            if ((curCash < BOXOPENINGCOST) && idleMode) {
                $('#oocpop').modal('show');
                /* feeling generous?
                alert("Looks like you have ran out of cash :(. Here's 50$");
                setCurrentCash(curCash + 50);
                updateCashDisplayAmt();
                curCash = getCurrentCash();
                */
            }
            else if (idleMode && curCash >= BOXOPENINGCOST) {
                openBox();
            };
        }

        //List collection items
        document.getElementById("btnCollection").addEventListener("click", updateCollection);

        function updateCollection() {

            var rowItemsDisplay = ""; //Need to be an empty string otherwise returns undefined

            Object.keys(itemDb).forEach((key) => {
                var localStorageKey = localStorage.getItem(key);
                rowItemsDisplay += "<tr>";
                    rowItemsDisplay += `<td id="itemThumb"><img src="${localStorageKey && (getItemAmount(key) > 0)? itemDb[key]["itemThumb"] : unknownItem}"></td>`;
                    rowItemsDisplay += `<td>${localStorageKey ? itemDb[key]["itemName"] : "???"}</td>`;
                    rowItemsDisplay += `<td>${localStorageKey ? localStorage.getItem(key) : "???"}</td>`;
                    if(localStorageKey && getItemAmount(key) > 0){
                        rowItemsDisplay += `<td><button class="btn btn-danger sell" id=${key}>${itemDb[key]["itemWorth"]}$</button></td>`;
                    } else {
                        rowItemsDisplay += `<td></td>`;
                    }
                rowItemsDisplay += "</tr>";
            });

            document.getElementById("colItems").innerHTML = `
            <table class="table">
                <thead>
                    <th></th>
                    <th>Name</th>
                    <th>Amount</th>
                    <th>Sell</th>
                </thead>
                <tbody>
                    ${rowItemsDisplay}
                </tbody>
            `;

            //Sell button
            var classSell = document.getElementsByClassName("sell");
            for (var i = 0; i < classSell.length; i++) {
                classSell[i].addEventListener("click", sell);
            }

            updateCashDisplayAmtCollection();
        }

        function sell() {
            var itemCount = getItemAmount(this.id);
            if(itemCount > 0) {
                localStorage.setItem(this.id, itemCount - 1);
                setCurrentCash(getCurrentCash() + itemDb[this.id]["itemWorth"]); //Should have a add cash method?
                updateCashDisplayAmtCollection();
                updateCashDisplayAmt();
                updateCollection();
            }
        }

        function restart(){
            var restart = confirm("Are you sure you want to restart the game? All your progress and cash will be wiped out!");
            if (restart) {
                localStorage.clear();
                setCurrentCash(STARTCASH);
                updateCashDisplayAmt();
                updateCashDisplayAmtCollection();
            }
        }
        //SORRY. HORRIBLE. will fix refactor soon tm?
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
</body>

</html>